name: Publish Release

on:
  push:
    branches: [main]
    paths:
      - 'gradle.properties'

permissions:
  contents: write
  packages: write
  id-token: write

jobs:
  publish:
    runs-on: ubuntu-x64
    steps:
      - name: Check if release commit
        id: check
        run: |
          COMMIT_MSG=$(cat "$GITHUB_EVENT_PATH" | jq -r '.head_commit.message')
          # Match "version X.Y.Z" (merge/rebase) or "Release vX.Y.Z" (squash merge)
          if [[ "$COMMIT_MSG" =~ ^version\ ([0-9]+\.[0-9]+\.[0-9]+) ]]; then
            echo "version=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
            echo "is_release=true" >> $GITHUB_OUTPUT
          elif [[ "$COMMIT_MSG" =~ ^Release\ v([0-9]+\.[0-9]+\.[0-9]+) ]]; then
            echo "version=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
            echo "is_release=true" >> $GITHUB_OUTPUT
          else
            echo "is_release=false" >> $GITHUB_OUTPUT
          fi

      - name: Get secrets
        if: steps.check.outputs.is_release == 'true'
        uses: grafana/shared-workflows/actions/get-vault-secrets@5cfbfd5d1cedbc711fc9358744a6d46b37eb88ee
        with:
          repo_secrets: |
            NEXUS_USERNAME=publishing:nexus_username
            NEXUS_PASSWORD=publishing:nexus_password
            NEXUS_GPG_KEY_ID=publishing:nexus_gpg_key_id
            NEXUS_GPG_PASSWORD=publishing:nexus_gpg_password
            NEXUS_GPG_SECRING_FILE_BASE64=publishing:nexus_gpg_secring_file
            GITHUB_APP_ID=pyroscope-development-app:app-id
            GITHUB_APP_PRIVATE_KEY=pyroscope-development-app:app-private-key

      - name: Generate GitHub token
        if: steps.check.outputs.is_release == 'true'
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2
        id: app-token
        with:
          app-id: ${{ env.GITHUB_APP_ID }}
          private-key: ${{ env.GITHUB_APP_PRIVATE_KEY }}

      - name: Checkout code
        if: steps.check.outputs.is_release == 'true'
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          token: ${{ steps.app-token.outputs.token }}
          persist-credentials: true

      - name: Set up Java 8
        if: steps.check.outputs.is_release == 'true'
        uses: actions/setup-java@c1e323688fd81a25caa38c78aa6df2d33d3e20d9 # v4
        with:
          java-version: '8'
          distribution: 'temurin'

      - name: Prepare GPG Keyring
        if: steps.check.outputs.is_release == 'true'
        id: prepare_gpg_keyring
        run: |
          mkdir -p ${{ github.workspace }}/gpg
          echo "$NEXUS_GPG_SECRING_FILE_BASE64" | base64 -d > ${{ github.workspace }}/gpg/secring.gpg
          chmod 600 ${{ github.workspace }}/gpg/secring.gpg
          echo "keyring_path=${{ github.workspace }}/gpg/secring.gpg" >> $GITHUB_OUTPUT

      - name: Build and Publish
        if: steps.check.outputs.is_release == 'true'
        run: |
          export NEXUS_GPG_SECRING_FILE=${{ steps.prepare_gpg_keyring.outputs.keyring_path }}
          make publish

      - name: Get GitHub App User ID
        if: steps.check.outputs.is_release == 'true'
        id: get-user-id
        run: echo "user-id=$(gh api "/users/${{ steps.app-token.outputs.app-slug }}[bot]" --jq .id)" >> "$GITHUB_OUTPUT"
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}

      - name: Create Tag
        if: steps.check.outputs.is_release == 'true'
        run: |
          git config --global user.name '${{ steps.app-token.outputs.app-slug }}[bot]'
          git config --global user.email '${{ steps.get-user-id.outputs.user-id }}+${{ steps.app-token.outputs.app-slug }}[bot]@users.noreply.github.com'
          git tag "v${{ steps.check.outputs.version }}"
          git push origin "v${{ steps.check.outputs.version }}"
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}

      - name: Create GitHub Release
        if: steps.check.outputs.is_release == 'true'
        run: |
          gh release create "v${{ steps.check.outputs.version }}" \
            build/libs/pyroscope-otel.jar \
            --title "Release v${{ steps.check.outputs.version }}" \
            --notes "Automated release"
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
